{% extends 'shared/base.html' %}
{% load static %}
{% block head %}
    <link rel="stylesheet" href="{% static 'css/chatroom.css' %}">
{% endblock %}
{% block title %}チャットルーム_{{ room_pk }}{% endblock %}
{% block content %}
    <div id="chat-container">
        <div id="search-container">
            <input class="fas fa-search" type="text" placeholder="Seach" style="
                    background: url({% static 'media/search.svg' %}) no-repeat rgba(198, 197, 199, 0.2);
                    background-position: 15px center;
                    background-size: 20px 20px;">
        </div>
        <div id="conversation-list">
            {% for user_room in user_room_list %}
                <div class="conversation">
                    <img src="{{ user_room.user.image.url }}" alt="">
                    <div class="chat-user-username">
                        {{ user_room.user.username }}
                    </div>
                    <div class="time-log">
                        Apr 14
                    </div>
                    <div class="conversation-message">
                        {{ user_room.user.message_set.1 }}
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="chat-title">
            <p>sample</p>
        </div>
        <ul id="chat-message-list">
            {% for message in room_messages %}
                {% if request.user == message.user %}
                    <li class="message-row sent">
                        <div class="message-content">
                            <div class="message-text">{{ message.message }}</div>
                            <div class="message-time">{{ message.created_at|date:"H:i" }}</div>
                        </div>
                    </li>
                {% else %}
                    <li class="message-row replies">
                        <div class="message-content">
                            <img src="{{ message.user.image.url }}" alt="user-icon">
                            <div class="message-text">{{ message.message }}</div>
                            <div class="message-time">{{ message.created_at|date:"H:i" }}</div>
                        </div>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
        <div id="chat-message-send-form">
            <div contenteditable="true" id="send-message-input-area"></div>
            <button id="message-sent" class="fa fa-paper-plane fa-2x">送信</button>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        let room_pk = {{ room_pk }};
        let username = {{ username }};

        const socket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + room_pk
            + '/'
        )

        document.querySelector('#message-sent').onclick = function sendMessage() {
            const messageTextAreaDom = document.querySelector('#send-message-input-area');
            console.log(messageTextAreaDom.textContent)
            const message = messageTextAreaDom.textContent;
            socket.send(JSON.stringify({
                author: username,
                message: message,
            }));
            messageTextAreaDom.textContent = "";
        }

        socket.onmessage = e => {
            let receiveData = JSON.parse(e.data);
            createMessage(receiveData);
        }


        socket.onclose = e => {
            console.error('Chat socket closed unexpectedly');
        }

        function createMessage(data) {
            console.log(data)
            let author = data['author'];
            let msgListTag = document.createElement('li');
            let content_divTag = document.createElement('div');
            let imgTag = document.createElement('img');
            let text_divTag = document.createElement('div');
            let create_at_divTag = document.createElement('div');
            msgListTag.className = "message-row"
            content_divTag.className = "message-content";
            text_divTag.className = "message-text";
            create_at_divTag.className = "message-time";
            create_at_divTag.textContent = data['created_at']
            text_divTag.textContent = data['message'];
            if (author === username) {
                msgListTag.className = 'message-row sent';
            } else {
                imgTag.src = "{{ other_user.image.url }}";
                content_divTag.appendChild(imgTag);
                msgListTag.className = 'message-row replies';
            }
            content_divTag.appendChild(text_divTag);
            content_divTag.appendChild(create_at_divTag);
            msgListTag.appendChild(content_divTag);
            document.querySelector('#chat-message-list').appendChild(msgListTag);
        }


    </script>
{% endblock %}