{% extends 'shared/base.html' %}
{% load static %}
{% block head %}
    <link rel="stylesheet" href="{% static 'css/chatroom.css' %}">
{% endblock %}
{% block title %}チャットルーム_{{ room_pk }}{% endblock %}
{% block content %}
    <div id="chat-container">
        <div id="search-container">
            <input class="fas fa-search" type="text" placeholder="Seach" style="
                    background: url({% static 'media/search.svg' %}) no-repeat rgba(198, 197, 199, 0.2);
                    background-position: 15px center;
                    background-size: 20px 20px;">
        </div>
        <div id="conversation-list">
            {% for chat_user in chat_user_list %}
                <div class="conversation">
                    <img src="{{ chat_user.user.image.url }}" alt="">
                    <div class="chat-user-username">
                        {{ chat_user.user.username }}
                    </div>
                    <div class="time-log">
                        Apr 14
                    </div>
                    <div class="conversation-message">

                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="chat-title">
            <p>sample</p>
        </div>
        <ul id="chat-message-list">
            {% for message in room_messages %}
                <li class="message-row {% if request.user == message.user %}sent{% else %}replies{% endif %}">
                    <div class="message-content">
                        <img src="{{ message.user.image.url }}" alt="ユーザーのアイコン画像">
                        <div class="message-text">{{ message.message }}</div>
                        <div class="message-time">{{ message.created_at }}</div>
                    </div>
                </li>
            {% endfor %}
        </ul>
        <div id="chat-message-send-form">
            <div contenteditable="true" id="send-message-area"></div>
            <button class="fa fa-paper-plane fa-2x message-sent">送信</button>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        let room_pk = {{ room_pk }};
        let username = {{ username }};

        const socket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + room_pk
            + '/'
        )

        document.querySelector('#chat-message-submit').onclick = function sendMessage() {
            const messageTextAreaDom = document.querySelector('#chat-message-textarea');
            const message = messageTextAreaDom.value;
            let textArray = message.split('\n');
            let newText = textArray.join('<br>');
            console.log(newText);
            socket.send(JSON.stringify({
                author: username,
                message: message,
            }));
            messageTextAreaDom.value = "";
        }

        socket.onmessage = e => {
            let receiveData = JSON.parse(e.data);
            createMessage(receiveData);
        }

        {#document.querySelector('#chat-message-textarea').focus();#}
        {#document.querySelector('#chat-message-textarea').onkeyup = function (e) {#}
        {#   if (e.keyCode === 13) {  // enter, return#}
        {#       let text = document.querySelector('#chat-message-textarea').value#}
        {#       let textArray = text.split('\n');#}
        {#       let newText = textArray.join('<br>');#}
        {#   }#}
        {# } #}

        socket.onclose = e => {
            console.error('Chat socket closed unexpectedly');
        }

        function createMessage(data) {
            console.log(data)
            let author = data['author'];
            let msgListTag = document.createElement('li');
            let imgTag = document.createElement('img');
            let divTag = document.createElement('div');
            divTag.textContent = data['message'];
            console.log(divTag.textContent);
            console.log(data['message']);
            imgTag.src = "{{ request.user.image.url }}";
            if (author === username) {
                msgListTag.className = 'sent';
            } else {
                msgListTag.className = 'replies';
            }
            msgListTag.appendChild(imgTag);
            msgListTag.appendChild(divTag);
            console.log(msgListTag);
            document.querySelector('#chat-log').appendChild(msgListTag);
        }


    </script>
{% endblock %}