{% extends 'shared/base.html' %}
{% load static %}
{% block title %}商品詳細ページ{% endblock %}
{% block content %}
    <div class="item-detail-page">
        <div class="item-detail-page-content">
            <div class="item-image-part">
                <div class="heading-image">
                    <div class="item-image-wrapper">
                        <img alt="選択中の商品画像" src="{{ thumbnail.image.url }}" id="featured" class="item-image">
                    </div>
                </div>
                <div class="image-preview-zone">
                    {% for item_image in item_images %}
                        {% if forloop.counter == 1 %}
                            <div class="item-image-wrapper">
                                <img alt="商品画像" src="{{ thumbnail.image.url }}"
                                     class="item-image select-image active_img">
                            </div>
                        {% else %}
                            <div class="item-image-wrapper">
                                <img alt="商品画像" src="{{ item_image.image.url }}" class="item-image select-image">
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="item-detail-part">
                <table class="table table-striped">
                    <tr>
                        <th>商品名</th>
                        <td>{{ item.name }}</td>
                    </tr>
                    <tr>
                        <th>商品の状態</th>
                        <td>{{ item.get_state_display }}</td>
                    </tr>
                    <tr>
                        <th>カテゴリ</th>
                        <td>{{ item.category }}</td>
                    </tr>
                    <tr>
                        <th>配送地</th>
                        <td>{{ item.get_shipping_area_display }}</td>
                    </tr>
                    <tr>
                        <th>配送日数</th>
                        <td>{{ item.get_shipping_day_display }}</td>
                    </tr>
                    <tr>
                        <th>出品日</th>
                        <td>{{ item.at_created }}</td>
                    </tr>
                </table>
                <div class="item-explanation-part">
                    {{ item.explanation }}
                </div>
            </div>
            <div class="like-part">
                {% include 'shared/like.html' %}
            </div>
            <form action="{% url 'request_item' %}" method="POST">
                {% csrf_token %}
                {% if requested %}
                    <button id="request_item_button" type="submit">申請済み</button>
                {% else %}
                    <button id="request_item_button" type="submit">取引申請する</button>
                {% endif %}

            </form>
        </div>
        <div class="item-comment-part-page">
            <ul class="comment-log">
                {% for cmt in comments %}
                    <li>{{ cmt.comment }}</li>
                {% endfor %}
            </ul>
            <div>
                <input id="comment-input-area" type="text" placeholder="コメントを残す">
                <button id="comment-sent" type="submit">送信</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        let selectImage = document.getElementsByClassName('select-image')
        let activeImage = document.getElementsByClassName('active_img')
        for (let i = 0; i < selectImage.length; i++) {
            console.log(activeImage)
            selectImage[i].addEventListener('click', function () {
                if (activeImage.length > 0) {
                    activeImage[0].classList.remove('active_img')
                }
                this.classList.add('active_img')
                document.getElementById('featured').src = this.src
            })
        }
    </script>
    <script>
        $(document).ready(function () {
            $(document).on('click', '#like', function (event) {
                event.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: "{% url 'likes' %}",
                    data: {
                        'item_pk': '{{ item.id }}',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    dataType: 'json',
                    success: function (response) {
                        console.log(response)
                        selector = document.getElementsByName(response.item_id)
                        if (response.liked) {
                            $(selector).html("<i class='fas fa-2x fa-heart like-red'></i>");
                        } else {
                            $(selector).html("<i class='far fa-2x fa-heart'></i>");
                        }
                        selector2 = document.getElementsByName(response.item_id + "-count");
                        $(selector2).text(response.count);
                    }
                });
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $(document).on('click', '#request_item_button', function (event) {
                event.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: "{% url 'request_item' %}",
                    data: {
                        'item_pk': '{{ item.id }}',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    dataType: 'json',
                    success: function (response) {
                        request_item_button = document.querySelector('#request_item_button');
                        if (response.requested) {
                            request_item_button.textContent = "申請済み";
                        } else {
                            request_item_button.textContent = "取引申請する";
                        }
                    }
                });
            });
        });
    </script>
    <script>
        let item_pk = {{ item.id }};
        let username = "{{ user.username }}";

        const socket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/item/'
            + item_pk
            + '/'
        )

        document.querySelector('#comment-sent').onclick = function sendMessage() {
            const comment = document.querySelector('#comment-input-area');
            const cmtValue = comment.value;
            socket.send(JSON.stringify({
                author: username,
                comment: cmtValue,
            }));
            comment.value = "";
        }

        socket.onmessage = e => {
            let receiveData = JSON.parse(e.data);
            createMessage(receiveData);
        }

        socket.onclose = e => {
            console.error('Comment socket closed unexpectedly');
        }

        function createMessage(data) {
            let author = data['author'];
            let comment = data['comment'];
            let created_at = data['created_at']
            let listTag = document.createElement('li');
            let divTag = document.createElement('div');
            divTag.textContent = data['comment']
            listTag.appendChild(divTag)
            document.querySelector('.comment-log').appendChild(listTag)
        }
    </script>
{% endblock %}